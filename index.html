<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoMojo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 0;
            margin: 0;
            min-height: 100vh;
            line-height: 1.5;
        }

        .page {
            display: none;
            min-height: 100vh;
            padding: 16px;
        }

        .page.active {
            display: block;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
        }

        /* Agreement Page */
        .agreement-header {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
        }

        .agreement-header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .agreement-content {
            background: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 70vh;
            overflow-y: auto;
            font-size: 14px;
        }

        .agreement-content h2 {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 10px 0;
            color: var(--tg-theme-button-color, #3390ec);
        }

        .agreement-content h3 {
            font-size: 14px;
            font-weight: 600;
            margin: 15px 0 8px 0;
        }

        .agreement-content p {
            margin-bottom: 12px;
        }

        .agreement-content ul {
            margin: 10px 0 10px 20px;
        }

        .agreement-content li {
            margin-bottom: 6px;
        }

        .submit-button {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 14px 16px;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .submit-button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Timezone Page Styles */
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .header p {
            font-size: 14px;
            opacity: 0.7;
            color: var(--tg-theme-hint-color, #999999);
        }

        .timezone-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
        }

        .current-time {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .current-time h2 {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .time-display {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .timezone-display {
            font-size: 14px;
            opacity: 0.8;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .auto-detect {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .auto-detect:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
            box-shadow: 0 0 0 2px rgba(51, 144, 236, 0.1);
        }

        .timezone-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            margin-bottom: 20px;
        }

        .timezone-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timezone-item:last-child {
            border-bottom: none;
        }

        .timezone-item:hover {
            background: var(--tg-theme-section-bg-color, #f8f9fa);
        }

        .timezone-item.selected {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .timezone-name {
            font-weight: 500;
            font-size: 14px;
        }

        .timezone-offset {
            font-size: 12px;
            opacity: 0.7;
        }

        .selected .timezone-offset {
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .success {
            background: #51cf66;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            .timezone-section {
                padding: 16px;
            }
            
            .time-display {
                font-size: 24px;
            }

            .agreement-content {
                font-size: 13px;
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Agreement Page -->
    <div id="agreement" class="page">
        <div class="container">
            <div class="agreement-header">
                <h1>Service Agreement</h1>
                <p>Terms and conditions for LingoMojo English learning services</p>
            </div>

            <div class="agreement-content">
                <h2>ДОГОВОР-ОФЕРТА ОКАЗАНИЯ ИНФОРМАЦИОННЫХ УСЛУГ</h2>
                
                <p><strong>Индивидуальный предприниматель Голубев Александр Павлович</strong> (ИНН 263211529547, ОГРНИП 323774600252134), именуемый в дальнейшем Исполнитель, действующий от собственного имени, адресует настоящий Договор-оферту любому лицу, выразившему готовность воспользоваться услугами Исполнителя (далее по тексту – Заказчик).</p>

                <h3>ТЕРМИНЫ И ОПРЕДЕЛЕНИЯ</h3>
                <ul>
                    <li><strong>Акцепт</strong> – ответ лица о полном и безоговорочном принятии оферты путем оформления и оплаты Заказа</li>
                    <li><strong>Веб-ресурс</strong> – чатбот для изучения английского языка https://t.me/LingoMojo_bot</li>
                    <li><strong>Услуги</strong> – информационные услуги в сфере изучения английского языка, включающие:
                        <ul>
                            <li>Предоставление информационных материалов для самостоятельной практики</li>
                            <li>Организация интерактивных заданий и упражнений</li>
                            <li>Предоставление напоминаний для регулярной практики</li>
                            <li>Автоматизированная обработка запросов пользователя</li>
                        </ul>
                    </li>
                    <li><strong>Период</strong> – 30 или 90 календарных дней доступа к Услугам</li>
                </ul>

                <h3>1. ОБЩИЕ ПОЛОЖЕНИЯ</h3>
                <p>1.1. Договор-оферта содержит все существенные условия договора оказания информационных услуг.</p>
                <p>1.2. Акцептом является оплата услуг Исполнителя за выбранный период.</p>
                <p>1.3. Заказчик подтверждает, что является совершеннолетним дееспособным лицом.</p>

                <h3>2. ПРЕДМЕТ ДОГОВОРА</h3>
                <p>2.1. Предметом Оферты является возмездное предоставление доступа к Услугам посредством веб-ресурса.</p>
                <p>2.2. Датой начала оказания Услуг считается дата оплаты доступа.</p>

                <h3>3. СТОИМОСТЬ И ВОЗВРАТ</h3>
                <p>3.1. Оплата производится в порядке 100% предоплаты в рублях.</p>
                <p>3.2. Пользователь вправе отказаться от Услуг в любое время. Исполнитель удерживает плату пропорционально фактически оказанному периоду.</p>
                <p>3.3. Расчет возврата: (общая стоимость / дни в периоде) × неиспользованные дни - расходы Исполнителя.</p>

                <h3>4. ОБЯЗАТЕЛЬСТВА ЗАКАЗЧИКА</h3>
                <ul>
                    <li>Соблюдать общепринятые нормы поведения</li>
                    <li>Не передавать доступ третьим лицам</li>
                    <li>Не копировать и не распространять материалы</li>
                    <li>Не использовать ненормативную лексику</li>
                </ul>

                <h3>5. ОТВЕТСТВЕННОСТЬ</h3>
                <p>5.1. Исполнитель не гарантирует 100% бесперебойности услуг.</p>
                <p>5.2. Исполнитель не несет ответственности за достижение конкретных результатов изучения языка.</p>
                <p>5.3. Споры разрешаются в судебном порядке по месту нахождения Исполнителя.</p>

                <h3>6. ПЕРСОНАЛЬНЫЕ ДАННЫЕ</h3>
                <p>Исполнитель не осуществляет обработку персональных данных. Адрес электронной почты не является персональными данными согласно решению Верховного суда РФ.</p>

                <p><strong>Контакты:</strong><br>
                ИП Голубев Александр Павлович<br>
                ИНН: 263211529547<br>
                Email: lingomojo@gmail.com<br>
                Веб-ресурс: https://t.me/LingoMojo_bot</p>

                <p><em>Последняя редакция от 21.09.2025</em></p>
            </div>

            <button class="submit-button" onclick="closeAgreement()">
                Close Agreement
            </button>
        </div>
    </div>

    <!-- Timezone Page -->
    <div id="timezone" class="page">
        <div class="container">
            <div class="header">
                <h1>Set Your Timezone</h1>
            </div>

            <div class="current-time">
                <h2>Current Time</h2>
                <div class="time-display" id="currentTime">--:--:--</div>
                <div class="timezone-display" id="currentTimezone">Loading...</div>
            </div>

            <div class="timezone-section">
                <div class="section-title">Quick Setup</div>
                <button class="auto-detect" onclick="autoDetectTimezone()">
                    Auto-detect my timezone
                </button>
                
                <div class="section-title">Or choose manually</div>
                <div class="search-container">
                    <input 
                        type="text" 
                        class="search-input" 
                        id="searchInput" 
                        placeholder="Search by city, country, or UTC offset (+3, -5, utc+8)..."
                        oninput="filterTimezones()"
                    >
                </div>
                
                <div id="messages"></div>
                
                <div class="timezone-list" id="timezoneList">
                    <div class="loading">Loading timezones...</div>
                </div>
                
                <button class="submit-button" id="submitButton" onclick="submitTimezone()" disabled>
                    Confirm & Set Timezone
                </button>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let selectedTimezone = null;
        let allTimezones = [];

        // Initialize the app
        tg.ready();
        tg.expand();

        // Get URL parameters to determine starting page
        const urlParams = new URLSearchParams(window.location.search);
        const startPage = urlParams.get('page') || 'agreement';

        // Show initial page
        document.addEventListener('DOMContentLoaded', function() {
            showPage(startPage);
            if (startPage === 'timezone') {
                loadTimezones();
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                setTimeout(() => {
                    autoDetectTimezone();
                }, 1000);
            }
        });

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        // Agreement functions
        function closeAgreement() {
            tg.close();
        }

        // Timezone functions
        const popularTimezones = [
            'Pacific/Kiritimati', 'Pacific/Auckland', 'Australia/Sydney', 'Australia/Melbourne',
            'Asia/Tokyo', 'Asia/Seoul', 'Asia/Shanghai', 'Asia/Hong_Kong', 'Asia/Singapore',
            'Asia/Bangkok', 'Asia/Jakarta', 'Asia/Mumbai', 'Asia/Kolkata', 'Asia/Dubai',
            'Europe/Moscow', 'Europe/Istanbul', 'Africa/Cairo', 'Europe/Berlin', 'Europe/Paris',
            'Europe/Rome', 'Europe/Madrid', 'Europe/London', 'Africa/Lagos', 'Africa/Johannesburg',
            'America/Sao_Paulo', 'America/New_York', 'America/Chicago', 'America/Denver',
            'America/Phoenix', 'America/Los_Angeles', 'America/Las_Vegas', 'America/Vancouver',
            'America/Anchorage', 'Pacific/Honolulu', 'Pacific/Midway'
        ];

        function getCityName(timezone) {
            const parts = timezone.split('/');
            const city = parts[parts.length - 1].replace(/_/g, ' ');
            return city;
        }

        function getCountryName(timezone) {
            const countryMap = {
                'Pacific/Kiritimati': 'Kiribati', 'Pacific/Auckland': 'New Zealand',
                'Australia/Sydney': 'Australia', 'Australia/Melbourne': 'Australia',
                'Asia/Tokyo': 'Japan', 'Asia/Seoul': 'South Korea', 'Asia/Shanghai': 'China',
                'Asia/Hong_Kong': 'Hong Kong', 'Asia/Singapore': 'Singapore',
                'Asia/Bangkok': 'Thailand', 'Asia/Jakarta': 'Indonesia', 'Asia/Mumbai': 'India',
                'Asia/Kolkata': 'India', 'Asia/Dubai': 'UAE', 'Europe/Moscow': 'Russia',
                'Europe/Istanbul': 'Turkey', 'Africa/Cairo': 'Egypt', 'Europe/Berlin': 'Germany',
                'Europe/Paris': 'France', 'Europe/Rome': 'Italy', 'Europe/Madrid': 'Spain',
                'Europe/London': 'United Kingdom', 'Africa/Lagos': 'Nigeria',
                'Africa/Johannesburg': 'South Africa', 'America/Sao_Paulo': 'Brazil',
                'America/New_York': 'United States', 'America/Chicago': 'United States',
                'America/Denver': 'United States', 'America/Phoenix': 'United States',
                'America/Los_Angeles': 'United States', 'America/Las_Vegas': 'United States',
                'America/Vancouver': 'Canada', 'America/Anchorage': 'United States',
                'Pacific/Honolulu': 'United States', 'Pacific/Midway': 'United States'
            };
            return countryMap[timezone] || timezone.split('/')[0].replace('_', ' ');
        }

        function getTimezoneOffsetMinutes(timezone) {
            try {
                const date = new Date('2023-07-15T00:00:00.000Z');
                
                const utc = new Intl.DateTimeFormat('sv-SE', {
                    timeZone: 'UTC',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }).formatToParts(date);
                
                const local = new Intl.DateTimeFormat('sv-SE', {
                    timeZone: timezone,
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit'
                }).formatToParts(date);
                
                const utcDate = new Date(
                    parseInt(utc.find(p => p.type === 'year').value),
                    parseInt(utc.find(p => p.type === 'month').value) - 1,
                    parseInt(utc.find(p => p.type === 'day').value),
                    parseInt(utc.find(p => p.type === 'hour').value),
                    parseInt(utc.find(p => p.type === 'minute').value)
                );
                
                const localDate = new Date(
                    parseInt(local.find(p => p.type === 'year').value),
                    parseInt(local.find(p => p.type === 'month').value) - 1,
                    parseInt(local.find(p => p.type === 'day').value),
                    parseInt(local.find(p => p.type === 'hour').value),
                    parseInt(local.find(p => p.type === 'minute').value)
                );
                
                const diffMs = localDate.getTime() - utcDate.getTime();
                return Math.round(diffMs / (1000 * 60));
                
            } catch (e) {
                return 0;
            }
        }

        function getTimezoneOffset(timezone) {
            try {
                const offsetMinutes = getTimezoneOffsetMinutes(timezone);
                const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
                const offsetMins = Math.abs(offsetMinutes) % 60;
                const sign = offsetMinutes >= 0 ? '+' : '-';
                
                if (offsetMins === 0) {
                    return `UTC${sign}${offsetHours}`;
                } else {
                    return `UTC${sign}${offsetHours}:${offsetMins.toString().padStart(2, '0')}`;
                }
            } catch (e) {
                return 'UTC+0';
            }
        }

        function loadTimezones() {
            allTimezones = popularTimezones.map(tz => ({
                id: tz,
                name: getCityName(tz),
                country: getCountryName(tz),
                offset: getTimezoneOffset(tz),
                offsetMinutes: getTimezoneOffsetMinutes(tz),
                popular: true
            }));

            allTimezones.sort((a, b) => {
                if (a.offsetMinutes !== b.offsetMinutes) {
                    return a.offsetMinutes - b.offsetMinutes;
                }
                return a.name.localeCompare(b.name);
            });

            displayTimezones(allTimezones);
        }

        function displayTimezones(timezones) {
            const list = document.getElementById('timezoneList');
            
            if (timezones.length === 0) {
                list.innerHTML = '<div class="loading">No timezones found</div>';
                return;
            }

            list.innerHTML = timezones.map(tz => `
                <div class="timezone-item" onclick="selectTimezone('${tz.id}', false)">
                    <div class="timezone-name">${tz.name} (${tz.country})</div>
                    <div class="timezone-offset">${tz.offset}</div>
                </div>
            `).join('');
        }

        function filterTimezones() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allTimezones.filter(tz => {
                const matchesName = tz.name.toLowerCase().includes(query);
                const matchesId = tz.id.toLowerCase().includes(query);
                const matchesCountry = tz.country.toLowerCase().includes(query);
                const matchesOffset = tz.offset.toLowerCase().includes(query);
                
                return matchesName || matchesId || matchesCountry || matchesOffset;
            });
            displayTimezones(filtered);
        }

        function selectTimezone(timezoneId, autoSubmit = false) {
            selectedTimezone = timezoneId;
            
            document.querySelectorAll('.timezone-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const timezoneItems = document.querySelectorAll('.timezone-item');
            timezoneItems.forEach(item => {
                const cityName = getCityName(timezoneId);
                if (item.textContent.includes(cityName)) {
                    item.classList.add('selected');
                }
            });
            
            updateCurrentTime();
            enableSubmitButton();
            
            if (autoSubmit) {
                sendTimezoneToBot(timezoneId);
            }
        }

        function enableSubmitButton() {
            const submitButton = document.getElementById('submitButton');
            submitButton.disabled = false;
            const cityName = selectedTimezone ? getCityName(selectedTimezone) : '';
            submitButton.textContent = `Confirm ${cityName}`;
        }

        function submitTimezone() {
            if (selectedTimezone) {
                sendTimezoneToBot(selectedTimezone);
            } else {
                showMessage('Please select a timezone first', 'error');
            }
        }

        function autoDetectTimezone() {
            try {
                const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                
                if (detectedTimezone) {
                    const foundTimezone = allTimezones.find(tz => tz.id === detectedTimezone);
                    
                    if (foundTimezone) {
                        selectTimezone(detectedTimezone, false);
                        showMessage('Timezone detected automatically: ' + getCityName(detectedTimezone), 'success');
                        
                        setTimeout(() => {
                            const selectedItem = document.querySelector('.selected');
                            if (selectedItem) {
                                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            }
                        }, 100);
                    } else {
                        selectedTimezone = detectedTimezone;
                        updateCurrentTime();
                        enableSubmitButton();
                        showMessage('Timezone detected: ' + getCityName(detectedTimezone) + ' (not in selection list)', 'success');
                    }
                } else {
                    showMessage('Could not detect timezone automatically', 'error');
                }
            } catch (error) {
                showMessage('Error during timezone detection: ' + error.message, 'error');
            }
        }

        function updateCurrentTime() {
            const now = new Date();
            const timezone = selectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            try {
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const cityName = getCityName(timezone);
                const offset = getTimezoneOffset(timezone);
                
                document.getElementById('currentTime').textContent = timeString;
                document.getElementById('currentTimezone').textContent = `${cityName} (${offset})`;
            } catch (error) {
                document.getElementById('currentTime').textContent = now.toLocaleTimeString();
                document.getElementById('currentTimezone').textContent = 'Local Time';
            }
        }

        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 3000);
        }

        function sendTimezoneToBot(timezone) {
            const data = {
                timezone: timezone,
                cityName: getCityName(timezone),
                offset: getTimezoneOffset(timezone),
                timestamp: new Date().toISOString()
            };
            
            // Send data to bot
            tg.sendData(JSON.stringify(data));
            
            showMessage('Timezone saved successfully!', 'success');
            
            // Close the miniapp after a short delay
            setTimeout(() => {
                tg.close();
            }, 1500);
        }

        // Handle back button
        tg.BackButton.onClick(() => {
            tg.close();
        });
    </script>
</body>
</html>
