<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Your Timezone</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 0;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            padding: 16px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 24px;
            padding: 16px 0;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }

        .header p {
            font-size: 14px;
            opacity: 0.7;
            color: var(--tg-theme-hint-color, #999999);
        }

        .timezone-section {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
        }

        .current-time {
            text-align: center;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .current-time h2 {
            font-size: 16px;
            margin-bottom: 8px;
            opacity: 0.9;
        }

        .time-display {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .timezone-display {
            font-size: 14px;
            opacity: 0.8;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--tg-theme-text-color, #000000);
        }

        .auto-detect {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            width: 100%;
            cursor: pointer;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .auto-detect:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .auto-detect:active {
            transform: translateY(0);
        }

        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #3390ec);
            box-shadow: 0 0 0 2px rgba(51, 144, 236, 0.1);
        }

        .timezone-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
        }

        .timezone-item {
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--tg-theme-section-separator-color, #e5e5e5);
            transition: background-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timezone-item:last-child {
            border-bottom: none;
        }

        .timezone-item:hover {
            background: var(--tg-theme-section-bg-color, #f8f9fa);
        }

        .timezone-item.selected {
            background: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
        }

        .timezone-name {
            font-weight: 500;
            font-size: 14px;
        }

        .timezone-offset {
            font-size: 12px;
            opacity: 0.7;
        }

        .selected .timezone-offset {
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .error {
            background: #ff6b6b;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .success {
            background: #51cf66;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                padding: 12px;
            }
            
            .timezone-section {
                padding: 16px;
            }
            
            .time-display {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Set Your Timezone</h1>
            <p>Choose your timezone for accurate time display</p>
        </div>

        <div class="current-time">
            <h2>Current Time</h2>
            <div class="time-display" id="currentTime">--:--:--</div>
            <div class="timezone-display" id="currentTimezone">Loading...</div>
        </div>

        <div class="timezone-section">
            <div class="section-title">Quick Setup</div>
            <button class="auto-detect" onclick="autoDetectTimezone()">
                üéØ Auto-detect my timezone
            </button>
            
            <div class="section-title">Or choose manually</div>
            <div class="search-container">
                <input 
                    type="text" 
                    class="search-input" 
                    id="searchInput" 
                    placeholder="Search for city or timezone..."
                    oninput="filterTimezones()"
                >
            </div>
            
            <div id="messages"></div>
            
            <div class="timezone-list" id="timezoneList">
                <div class="loading">Loading timezones...</div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let selectedTimezone = null;
        let allTimezones = [];

        // Initialize the app
        tg.ready();
        tg.expand();

        // Popular timezones with major cities
        const popularTimezones = [
            'Pacific/Kiritimati',        // UTC+14 (Line Islands)
            'Pacific/Auckland',          // UTC+12/+13 (New Zealand)
            'Australia/Sydney',          // UTC+10/+11 (Australia)
            'Australia/Melbourne',       // UTC+10/+11 (Australia)
            'Asia/Tokyo',               // UTC+9 (Japan)
            'Asia/Seoul',               // UTC+9 (South Korea)
            'Asia/Shanghai',            // UTC+8 (China)
            'Asia/Hong_Kong',           // UTC+8 (Hong Kong)
            'Asia/Singapore',           // UTC+8 (Singapore)
            'Asia/Bangkok',             // UTC+7 (Thailand)
            'Asia/Jakarta',             // UTC+7 (Indonesia)
            'Asia/Mumbai',              // UTC+5:30 (India)
            'Asia/Kolkata',             // UTC+5:30 (India - same as Mumbai)
            'Asia/Dubai',               // UTC+4 (UAE)
            'Europe/Moscow',            // UTC+3 (Russia)
            'Europe/Istanbul',          // UTC+3 (Turkey)
            'Africa/Cairo',             // UTC+2 (Egypt)
            'Europe/Berlin',            // UTC+1/+2 (Germany)
            'Europe/Paris',             // UTC+1/+2 (France)
            'Europe/Rome',              // UTC+1/+2 (Italy)
            'Europe/Madrid',            // UTC+1/+2 (Spain)
            'Europe/London',            // UTC+0/+1 (UK)
            'Africa/Lagos',             // UTC+1 (Nigeria)
            'Africa/Johannesburg',      // UTC+2 (South Africa)
            'America/Sao_Paulo',        // UTC-3 (Brazil)
            'America/New_York',         // UTC-5/-4 (US East)
            'America/Chicago',          // UTC-6/-5 (US Central)
            'America/Denver',           // UTC-7/-6 (US Mountain)
            'America/Phoenix',          // UTC-7 (Arizona - no DST)
            'America/Los_Angeles',      // UTC-8/-7 (US Pacific)
            'America/Las_Vegas',        // UTC-8/-7 (Nevada)
            'America/Vancouver',        // UTC-8/-7 (Canada Pacific)
            'America/Anchorage',        // UTC-9/-8 (Alaska)
            'Pacific/Honolulu',         // UTC-10 (Hawaii)
            'Pacific/Midway'            // UTC-11 (Midway Island)
        ];

        // Get readable city name from timezone
        function getCityName(timezone) {
            const parts = timezone.split('/');
            const city = parts[parts.length - 1].replace(/_/g, ' ');
            return city;
        }

        // Get timezone offset in minutes (bulletproof method)
        function getTimezoneOffsetMinutes(timezone) {
            try {
                // Use a fixed date in summer to get consistent results
                const date = new Date('2023-07-15T00:00:00.000Z');
                
                // Create formatters for UTC and target timezone
                const utc = new Intl.DateTimeFormat('sv-SE', {
                    timeZone: 'UTC',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).formatToParts(date);
                
                const local = new Intl.DateTimeFormat('sv-SE', {
                    timeZone: timezone,
                    year: 'numeric', 
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }).formatToParts(date);
                
                // Extract values from parts
                const utcDate = new Date(
                    parseInt(utc.find(p => p.type === 'year').value),
                    parseInt(utc.find(p => p.type === 'month').value) - 1,
                    parseInt(utc.find(p => p.type === 'day').value),
                    parseInt(utc.find(p => p.type === 'hour').value),
                    parseInt(utc.find(p => p.type === 'minute').value)
                );
                
                const localDate = new Date(
                    parseInt(local.find(p => p.type === 'year').value),
                    parseInt(local.find(p => p.type === 'month').value) - 1,
                    parseInt(local.find(p => p.type === 'day').value),
                    parseInt(local.find(p => p.type === 'hour').value),
                    parseInt(local.find(p => p.type === 'minute').value)
                );
                
                // Calculate difference in minutes
                const diffMs = localDate.getTime() - utcDate.getTime();
                return Math.round(diffMs / (1000 * 60));
                
            } catch (e) {
                console.error(`Error with ${timezone}:`, e);
                // Last resort: use a hardcoded map for common problematic timezones
                const offsetMap = {
                    'America/Las_Vegas': -420,    // UTC-7 (PDT)
                    'America/Los_Angeles': -420,  // UTC-7 (PDT)  
                    'America/Phoenix': -420,      // UTC-7 (no DST)
                    'Asia/Mumbai': 330,           // UTC+5:30
                    'Asia/Kolkata': 330,          // UTC+5:30
                    'Asia/Dubai': 240,            // UTC+4
                    'Europe/London': 60,          // UTC+1 (BST)
                    'America/New_York': -240,     // UTC-4 (EDT)
                    'America/Chicago': -300,      // UTC-5 (CDT)
                };
                
                return offsetMap[timezone] || 0;
            }
        }

        // Get timezone offset string
        function getTimezoneOffset(timezone) {
            try {
                const offsetMinutes = getTimezoneOffsetMinutes(timezone);
                const offsetHours = Math.floor(Math.abs(offsetMinutes) / 60);
                const offsetMins = Math.abs(offsetMinutes) % 60;
                const sign = offsetMinutes >= 0 ? '+' : '-';
                
                if (offsetMins === 0) {
                    return `UTC${sign}${offsetHours}`;
                } else {
                    return `UTC${sign}${offsetHours}:${offsetMins.toString().padStart(2, '0')}`;
                }
            } catch (e) {
                return 'UTC+0';
            }
        }

        // Load and display timezones
        function loadTimezones() {
            // Create timezone list with popular ones first
            allTimezones = popularTimezones.map(tz => ({
                id: tz,
                name: getCityName(tz),
                region: tz.split('/')[0],
                offset: getTimezoneOffset(tz),
                offsetMinutes: getTimezoneOffsetMinutes(tz),
                popular: true
            }));

            // Add more timezones including extreme offsets
            const additionalTimezones = [
                'Asia/Tbilisi', 'Asia/Yerevan', 'Asia/Baku', 
                'Europe/Helsinki', 'Europe/Stockholm', 'Europe/Warsaw', 
                'Europe/Prague', 'Europe/Vienna', 'Europe/Zurich', 'Europe/Amsterdam',
                'Europe/Kiev', 'America/Toronto', 'America/Montreal', 'America/Mexico_City',
                'Asia/Karachi', 'Asia/Tashkent', 'Asia/Almaty',
                'Pacific/Samoa',        // UTC-11
                'Pacific/Niue',         // UTC-11  
                'Pacific/Marquesas',    // UTC-9:30
                'Pacific/Gambier',      // UTC-9
                'Pacific/Pitcairn',     // UTC-8
                'Pacific/Easter',       // UTC-6/-5 (Easter Island)
                'America/St_Johns',     // UTC-3:30 (Newfoundland)
                'Atlantic/Cape_Verde',  // UTC-1
                'Pacific/Chatham',      // UTC+12:45/+13:45
                'Pacific/Tongatapu',    // UTC+13
                'Pacific/Fakaofo'       // UTC+13
            ];

            additionalTimezones.forEach(tz => {
                if (!allTimezones.find(t => t.id === tz)) {
                    allTimezones.push({
                        id: tz,
                        name: getCityName(tz),
                        region: tz.split('/')[0],
                        offset: getTimezoneOffset(tz),
                        offsetMinutes: getTimezoneOffsetMinutes(tz),
                        popular: false
                    });
                }
            });

            // Sort by UTC offset (from UTC-12 to UTC+12), then by name within same offset
            allTimezones.sort((a, b) => {
                // First sort by offset
                if (a.offsetMinutes !== b.offsetMinutes) {
                    return a.offsetMinutes - b.offsetMinutes;
                }
                // If same offset, sort by name
                return a.name.localeCompare(b.name);
            });

            displayTimezones(allTimezones);
        }

        // Display timezones in the list
        function displayTimezones(timezones) {
            const list = document.getElementById('timezoneList');
            
            if (timezones.length === 0) {
                list.innerHTML = '<div class="loading">No timezones found</div>';
                return;
            }

            list.innerHTML = timezones.map(tz => `
                <div class="timezone-item" onclick="selectTimezone('${tz.id}')">
                    <div class="timezone-name">${tz.name} (${tz.region.replace('_', ' ')})</div>
                    <div class="timezone-offset">${tz.offset}</div>
                </div>
            `).join('');
        }

        // Filter timezones based on search
        function filterTimezones() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allTimezones.filter(tz => 
                tz.name.toLowerCase().includes(query) || 
                tz.id.toLowerCase().includes(query) ||
                tz.region.toLowerCase().includes(query)
            );
            displayTimezones(filtered);
        }

        // Select a timezone
        function selectTimezone(timezoneId) {
            selectedTimezone = timezoneId;
            
            // Update UI
            document.querySelectorAll('.timezone-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.timezone-item').classList.add('selected');
            
            // Update current time display
            updateCurrentTime();
            
            // Send data back to bot
            sendTimezoneToBot(timezoneId);
        }

        // Auto-detect timezone
        function autoDetectTimezone() {
            try {
                const detectedTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                if (detectedTimezone) {
                    selectTimezone(detectedTimezone);
                    showMessage('‚úÖ Timezone detected automatically!', 'success');
                    
                    // Scroll to show the detected timezone
                    const selectedItem = document.querySelector('.selected');
                    if (selectedItem) {
                        selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    showMessage('‚ùå Could not detect timezone automatically', 'error');
                }
            } catch (error) {
                showMessage('‚ùå Could not detect timezone automatically', 'error');
            }
        }

        // Update current time display
        function updateCurrentTime() {
            const now = new Date();
            const timezone = selectedTimezone || Intl.DateTimeFormat().resolvedOptions().timeZone;
            
            try {
                const timeString = now.toLocaleTimeString('en-US', {
                    timeZone: timezone,
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const cityName = getCityName(timezone);
                const offset = getTimezoneOffset(timezone);
                
                document.getElementById('currentTime').textContent = timeString;
                document.getElementById('currentTimezone').textContent = `${cityName} (${offset})`;
            } catch (error) {
                document.getElementById('currentTime').textContent = now.toLocaleTimeString();
                document.getElementById('currentTimezone').textContent = 'Local Time';
            }
        }

        // Show message to user
        function showMessage(text, type) {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="${type}">${text}</div>`;
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 3000);
        }

        // Send timezone data to bot
        function sendTimezoneToBot(timezone) {
            const data = {
                timezone: timezone,
                cityName: getCityName(timezone),
                offset: getTimezoneOffset(timezone),
                timestamp: new Date().toISOString()
            };
            
            // Send data to bot
            tg.sendData(JSON.stringify(data));
            
            showMessage('‚úÖ Timezone saved successfully!', 'success');
            
            // Close the miniapp after a short delay
            setTimeout(() => {
                tg.close();
            }, 1500);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadTimezones();
            updateCurrentTime();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            
            // Auto-detect on load if no timezone selected
            setTimeout(autoDetectTimezone, 1000);
        });

        // Handle back button
        tg.BackButton.onClick(() => {
            tg.close();
        });
    </script>
</body>
</html>
